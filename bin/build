#!/bin/bash

set -e

usage() {
	echo "Usage: bin/build [--yaml <openapi-yaml>] [--version <gem-version>] [--skip-generate] [--local-cli]"
	echo
	echo "Options:"
	echo "  -y, --yaml       The OpenAPI yaml file to process. (default: latest intersight-openapi-*.yaml in the current directory)"
	echo "  -v, --version    The gem version to generate. (default: value in lib/intersight_client/version.rb)"
	echo "  --skip-generate  Skip the openapi-generator step and continue on applying the patches."
	echo "  --local-cli      Use a locally installed openapi-generator instead of the docker based one."
}

while [[ $# -gt 0 ]]; do
	case $1 in
	-y|--yaml)
		YAML_FILE="$2"; shift ;;
	-v|--version)
		GEM_VERSION="$2"; shift; ;;
	--skip-generate)
		SKIP_GENERATE="true" ;;
	--local-cli)
		LOCAL_CLI="true" ;;
	-h|--help)
		usage; exit 0 ;;
	*)
		echo "ERROR: Unknown option $1"; echo; usage; exit 1 ;;
	esac
	shift
done

YAML_FILE=${YAML_FILE:-$(ls intersight-openapi-*.yaml | tail -n 1)}
GEM_VERSION=${GEM_VERSION:-$(grep VERSION lib/intersight_client/version.rb | cut -d "'" -f 2)}

additionalProperties="legacyDiscriminatorBehavior=false,gemAuthor=XLAB,gemHomepage=https://github.com/xlab-si/intersight-sdk-ruby,gemDescription=\"Gem for interaction with Cisco Intersight API\",gemName=intersight_client,moduleName=IntersightClient,gemLicense=\"Apache-2.0\",gemVersion=$GEM_VERSION"
templateDir='bin/oas_generator/templates/'

set -x

if [ -z "$SKIP_GENERATE" ]; then
	if [ -n "$LOCAL_CLI" ]; then
		openapi-generator generate -g ruby -i $YAML_FILE -t $templateDir --additional-properties "$additionalProperties"
	else
		docker run --rm -v ${PWD}:/local openapitools/openapi-generator-cli:v5.3.1 generate -g ruby -o /local/ -i /local/$YAML_FILE -t /local/$templateDir --additional-properties "$additionalProperties"
	fi
fi

# If needed, change ownership of files generated by the Docker container
chown -R $(id -un):$(id -gn) .

# Fix syntax of regular expressions
bin/oas_generator/regex-syntax-fix.sh

# Change the requires to autoload to save on memory and time
bin/oas_generator/autoload-requires.rb

# Patch `lib/openapi_client/api_client.rb` and `lib/openapi_client/configuration.rb`
# to include API key config + ECDSA signing auth
patch -p1 < bin/oas_generator/patch-auth.diff

# Fix incorrect type discriminator names in model files
bin/oas_generator/replace-discriminator-names.sh
